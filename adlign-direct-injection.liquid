<!-- 
===========================================
ğŸš€ ADLIGN - INJECTION DIRECTE DANS LA PAGE
===========================================
Script qui s'injecte directement dans la page produit
Sans passer par les templates - injection DOM directe
-->

<script>
(function() {
  // VÃ©rifier qu'on est bien sur une page produit
  if (!window.location.pathname.includes('/products/')) {
    return;
  }
  
  console.log('ğŸš€ [ADLIGN DIRECT] === INJECTION DIRECTE ===');
  
  // Garde-fou anti-double exÃ©cution
  if (window.AdlignDirectActive) {
    console.log('ğŸ”„ [ADLIGN DIRECT] DÃ©jÃ  actif - skip');
    return;
  }
  window.AdlignDirectActive = true;
  
  // Supprimer toutes les anciennes variables
  console.log('ğŸ§¹ [ADLIGN DIRECT] Nettoyage variables...');
  delete window.AdlignActivated;
  delete window.AdlignAPIActive;
  delete window.AdlignHardcodedActive;
  delete window.AdlignIntegrationActive;
  console.log('âœ… [ADLIGN DIRECT] Variables nettoyÃ©es');
  
  // DÃ©tection paramÃ¨tres URL
  const urlParams = new URLSearchParams(window.location.search);
  const adlignVariant = urlParams.get('adlign_variant');
  
  if (!adlignVariant) {
    console.log('ğŸ” [ADLIGN DIRECT] Aucun paramÃ¨tre adlign_variant - mode normal');
    return;
  }
  
  console.log(`ğŸ¯ [ADLIGN DIRECT] ParamÃ¨tre dÃ©tectÃ©: ${adlignVariant}`);
  
  // Configuration des campagnes
  const campaigns = {
    'test': {
      campaign_name: 'Test Campaign - Injection Directe',
      changes: {
        title: 'ğŸ¯ INJECTION DIRECTE RÃ‰USSIE !',
        cta: 'ğŸ¯ INJECTION DIRECTE',
        description: '<p><strong>âœ… Injection directe fonctionnelle !</strong> Plus d\'ancien script.</p>'
      }
    },
    'promo': {
      campaign_name: 'Promotion SpÃ©ciale',
      changes: {
        title: 'ğŸ”¥ OFFRE SPÃ‰CIALE LIMITÃ‰E - 50% DE RÃ‰DUCTION',
        cta: 'ğŸ”¥ PROFITER DE L\'OFFRE',
        description: '<p><strong>ğŸ”¥ Promotion exceptionnelle !</strong> Offre valable jusqu\'Ã  Ã©puisement des stocks. Livraison gratuite incluse.</p>'
      }
    }
  };
  
  // SÃ©lecteurs ultra-simples (SANS le prix pour l'instant)
  const selectors = {
    title: ['h1'],
    cta: ['button[type="submit"]', '[name="add"]'],
    description: ['.product__description:not(.price)', '.rte:not(.price)', '.product-description']
  };
  
  // Application immÃ©diate
  const campaign = campaigns[adlignVariant];
  if (!campaign) {
    console.log(`âŒ [ADLIGN DIRECT] Campaign '${adlignVariant}' non trouvÃ©e`);
    return;
  }
  
  console.log(`ğŸ¨ [ADLIGN DIRECT] Application: ${campaign.campaign_name}`);
  
  let modificationsAppliquees = 0;
  
  Object.entries(selectors).forEach(([type, selectorList]) => {
    if (!campaign.changes[type]) return;
    
    for (const selector of selectorList) {
      const elements = document.querySelectorAll(selector);
      if (elements.length > 0) {
        elements.forEach(element => {
          // SÃ©curitÃ© : ne pas modifier si c'est un Ã©lÃ©ment de prix
          if (element.closest('.price') || 
              element.classList.contains('price') || 
              element.classList.contains('money') ||
              element.textContent.includes('â‚¬') || 
              element.textContent.includes('$')) {
            console.log(`âš ï¸ [ADLIGN DIRECT] ${type} - Ã‰lÃ©ment prix ignorÃ©:`, element);
            return;
          }
          
          // Marquer
          element.setAttribute('data-adlign-direct', 'true');
          element.setAttribute('data-adlign-variant', adlignVariant);
          
          // Modifier selon le type
          if (type === 'description') {
            element.innerHTML = campaign.changes[type];
          } else {
            // Pour title et cta, on garde le texte simple
            element.textContent = campaign.changes[type];
          }
          
          // Animation
          element.style.background = 'rgba(147, 51, 234, 0.2)';
          element.style.transition = 'all 0.5s ease';
          setTimeout(() => element.style.background = '', 2000);
          
          modificationsAppliquees++;
          console.log(`âœ¨ [ADLIGN DIRECT] ${type} modifiÃ© avec ${selector}`);
        });
        break; // Premier sÃ©lecteur qui marche
      }
    }
  });
  
  if (modificationsAppliquees > 0) {
    // Notification
    const notification = document.createElement('div');
    notification.innerHTML = `
      <strong>ğŸ¯ ${campaign.campaign_name}</strong><br>
      <small>${modificationsAppliquees} Ã©lÃ©ments modifiÃ©s</small><br>
      <small>âœ… Injection directe active</small>
    `;
    notification.style.cssText = `
      position: fixed; top: 20px; right: 20px; 
      background: linear-gradient(135deg, #8b5cf6, #7c3aed); 
      color: white; padding: 15px 20px; border-radius: 12px; 
      font-weight: 600; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: 2px solid rgba(255,255,255,0.2);
    `;
    document.body.appendChild(notification);
    setTimeout(() => {
      if (document.body.contains(notification)) {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 300);
      }
    }, 5000);
    
    console.log(`ğŸ‰ [ADLIGN DIRECT] SuccÃ¨s ! ${modificationsAppliquees} modifications`);
  }
  
  // Debug global
  window.AdlignDirectDebug = {
    variant: adlignVariant,
    modifications: modificationsAppliquees,
    active: true
  };
  
  window.debugAdlignDirect = function() {
    console.log('ğŸ” [DEBUG DIRECT]');
    console.log('- Variant:', window.AdlignDirectDebug?.variant);
    console.log('- Modifications:', window.AdlignDirectDebug?.modifications);
    console.log('- Ã‰lÃ©ments marquÃ©s:', document.querySelectorAll('[data-adlign-direct="true"]').length);
    
    // Test sÃ©lecteurs
    console.log('ğŸ¯ Test sÃ©lecteurs:');
    Object.entries(selectors).forEach(([type, selectorArray]) => {
      console.log(`  ${type}:`);
      selectorArray.forEach(sel => {
        const count = document.querySelectorAll(sel).length;
        console.log(`    ${sel}: ${count} Ã©lÃ©ments`);
      });
    });
  };
  
  console.log('ğŸ’¡ [ADLIGN DIRECT] Tapez debugAdlignDirect() pour dÃ©bugger');
  console.log('ğŸ¯ [ADLIGN DIRECT] === INJECTION TERMINÃ‰E ===');
})();
</script>
